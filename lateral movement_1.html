<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hoist + Rigid Chains (Double Pendulum w/ Moving Pivot) → Excel Export</title>
<meta name="description" content="Hoist moving left/right, two rigid chains (0.1kg each), work mass variable. Exports angles and work vx to Excel.">
<style>
:root{--bg:#0b1020;--fg:#e8eef9;--muted:#9fb3d9;--card:#121a33;--good:#26d07c;--arm:#ff5a5a;--cab:#7fb6ff}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
.wrap{display:grid;grid-template-columns:360px 1fr;gap:14px;height:100%;padding:14px;box-sizing:border-box}
.card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.panel{padding:14px;display:flex;flex-direction:column;gap:10px}
h1{font-size:18px;margin:0 0 6px}
h2{font-size:13px;margin:8px 0 2px;color:var(--muted);font-weight:600}
.legend{font-size:12px;color:var(--muted)}
.row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.row label{min-width:120px;font-size:12px;color:var(--muted)}
input[type=number]{width:100px;padding:.35rem .5rem;border-radius:10px;border:1px solid #2a3a6a;background:#0e1633;color:var(--fg)}
.btn{background:linear-gradient(180deg,#3a76ff,#2b59d9);border:none;color:#fff;border-radius:12px;padding:9px 12px;cursor:pointer;font-weight:600}
.btn.secondary{background:#19254a;color:var(--fg);border:1px solid #2a3a6a}
canvas{width:100%;height:100%;display:block}
hr{border:none;height:1px;background:#1b2445;margin:8px 0}
.small{font-size:12px;color:var(--muted)}
.kbd{display:inline-block;padding:1px 6px;border-radius:8px;background:#10172a;border:1px solid #1d2744;font-size:12px;color:#b9c7ea}
.out{white-space:pre-wrap;background:#0e152e;padding:8px;border-radius:10px}
</style>
<!-- Excel (SheetJS) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <!-- Control panel -->
  <div class="card panel">
    <h1>ホイスト + 剛体チェーン①② + ワーク（Excel出力）</h1>
    <div class="legend">
      単位=メートル（内部）、重力=9.81 m/s²。チェーンは剛体長・質量各0.1 kg、ヒンジは角度拘束なし。<br>
      操作：<span class="kbd">←</span>/<span class="kbd">→</span>=±1.0 m/s²、<span class="kbd">Space</span>=ブレーキ、<span class="kbd">P</span>=一時停止、<span class="kbd">R</span>=リセット
    </div>
    <h2>パラメータ</h2>
    <div class="row"><label>L1 [m]（チェーン①長）</label><input id="L1" type="number" step="0.01" value="1.50"></div>
    <div class="row"><label>L2 [m]（チェーン②長）</label><input id="L2" type="number" step="0.01" value="1.80"></div>
    <div class="row"><label>Work mass [kg]</label><input id="mwork" type="number" step="1" value="400"></div>
    <div class="row"><label>dt [s]</label><input id="dt" type="number" step="0.0005" value="0.001"></div>
    <div class="row"><label>Total time [s]</label><input id="T" type="number" step="0.1" value="12"></div>
    <div class="row"><label>a_max [m/s²]</label><input id="amax" type="number" step="0.1" value="1.0">
                <label>v_max [m/s]</label><input id="vmax" type="number" step="0.01" value="0.33"></div>

    <h2>操作</h2>
    <div class="row">
      <button class="btn" id="start">開始/再開</button>
      <button class="btn secondary" id="pause">一時停止</button>
      <button class="btn secondary" id="reset">リセット</button>
      <button class="btn" id="download">Excel をダウンロード</button>
    </div>
    <hr/>
    <div id="status" class="small">Ready.</div>
    <div id="readout" class="out small"></div>
  </div>

  <!-- Canvas -->
  <div class="card" style="position:relative;overflow:hidden">
    <canvas id="cv"></canvas>
  </div>
</div>

<script>
/* ============================
   数学ユーティリティ
============================ */
const g   = 9.81;
const RAD = Math.PI/180, DEG = 180/Math.PI;
function add(a,b){return {x:a.x+b.x, y:a.y+b.y};}
function sub(a,b){return {x:a.x-b.x, y:a.y-b.y};}
function len(v){return Math.hypot(v.x,v.y);}
function norm(v){const L=len(v)||1; return {x:v.x/L, y:v.y/L};}
function dot(a,b){return a.x*b.x + a.y*b.y;}
function mul(v,k){return {x:v.x*k, y:v.y*k};}
function clamp(v,lo,hi){return v<lo?lo:(v>hi?hi:v);}

/* ============================
   Canvas
============================ */
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const DPR = Math.max(1, window.devicePixelRatio||1);
function resize(){ const r=cv.getBoundingClientRect(); const w=Math.floor(r.width*DPR), h=Math.floor(r.height*DPR); if(cv.width!==w||cv.height!==h){cv.width=w;cv.height=h;} }
function ppm(){ const W=cv.width,H=cv.height; return Math.max(Math.min(W/10, H/7), 80); } // ~1m = scale
window.addEventListener('resize', resize); resize();
function draw(){
  const W=cv.width, H=cv.height, s=ppm();
  const ox=W*0.5, oy=H*0.2; // world (m) to screen
  const sx=x=>ox + x*s, sy=y=>oy - y*s;

  ctx.clearRect(0,0,W,H);
  // grid (0.5m)
  ctx.save(); ctx.lineWidth=1; ctx.strokeStyle='#132048';
  for(let x=-20;x<=20;x+=0.5){ ctx.beginPath(); ctx.moveTo(sx(x),0); ctx.lineTo(sx(x),H); ctx.stroke(); }
  for(let y=-8;y<=8;y+=0.5){ ctx.beginPath(); ctx.moveTo(0,sy(y)); ctx.lineTo(W,sy(y)); ctx.stroke(); }
  ctx.restore();

  // hoist box
  ctx.fillStyle='#26d07c';
  ctx.fillRect(sx(state.x0)-0.25*s, sy(0.2), 0.5*s, 0.2*s); // 0.5m×0.2m
  // chain lines
  ctx.strokeStyle='#7bd6a8'; ctx.lineWidth=3;
  ctx.beginPath(); ctx.moveTo(sx(state.x0), sy(0)); ctx.lineTo(sx(state.r1.x), sy(state.r1.y)); ctx.stroke();
  ctx.strokeStyle='#ff9a9a'; ctx.beginPath(); ctx.moveTo(sx(state.r1.x), sy(state.r1.y)); ctx.lineTo(sx(state.r2.x), sy(state.r2.y)); ctx.stroke();

  // joints
  ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(sx(state.x0), sy(0), 3, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(sx(state.r1.x), sy(state.r1.y), 3, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(sx(state.r2.x), sy(state.r2.y), 3, 0, Math.PI*2); ctx.fill();

  // work (simple box 0.9×0.6m centered at r2)
  ctx.fillStyle='rgba(127,182,255,0.9)';
  ctx.fillRect(sx(state.r2.x)-0.45*s, sy(state.r2.y)+0.3*s, 0.9*s, 0.6*s);

  // text
  readout.textContent =
    `t=${state.t.toFixed(3)} s  x0=${state.x0.toFixed(3)} m  v0=${state.v0.toFixed(3)} m/s\n`+
    `θ1=${(state.theta1*DEG).toFixed(2)} deg  θ2=${(state.theta2*DEG).toFixed(2)} deg   vx(work)=${state.v2.x.toFixed(3)} m/s`;
}

/* ============================
   パラメータと状態
============================ */
const ref = {
  L1: document.getElementById('L1'),
  L2: document.getElementById('L2'),
  mwork: document.getElementById('mwork'),
  dt: document.getElementById('dt'),
  T: document.getElementById('T'),
  amax: document.getElementById('amax'),
  vmax: document.getElementById('vmax'),
};
const statusEl = document.getElementById('status');
const readout = document.getElementById('readout');

function params(){
  return {
    L1: +ref.L1.value, L2: +ref.L2.value,
    m1: 0.1,                             // chain1 mass
    m2: 0.1 + (+ref.mwork.value),        // chain2 mass + work
    dt: +ref.dt.value,
    T:  +ref.T.value,
    amax: +ref.amax.value,
    vmax: +ref.vmax.value,
  };
}
let P = params();

let state = {
  t: 0,
  // hoist base
  x0: 0, v0: 0, a0: 0,
  // joints and velocities
  r1: {x:0,y:0}, v1: {x:0,y:0},
  r2: {x:0,y:0}, v2: {x:0,y:0},
  // angles for display
  theta1: 0, theta2: 0,
};

// data buffers for Excel
let dataTime=[], dataTh1=[], dataTh2=[], dataVx=[];

/* ============================
   初期化・リセット
============================ */
function reset(){
  P = params();
  state.t = 0;
  state.x0 = 0; state.v0 = 0; state.a0 = 0;
  // vertical initial placement (downward)
  state.r1 = {x: state.x0, y: -P.L1};
  state.r2 = {x: state.x0, y: -P.L1 - P.L2};
  state.v1 = {x:0,y:0};
  state.v2 = {x:0,y:0};
  dataTime=[]; dataTh1=[]; dataTh2=[]; dataVx=[];
  paused=false;
  statusEl.textContent = 'Reset done.';
  draw();
}
reset();

/* ============================
   キー操作（台車）
============================ */
let keyL=false, keyR=false, keyBrake=false, paused=false;
addEventListener('keydown',e=>{
  if(e.code==='ArrowLeft') keyL=true;
  if(e.code==='ArrowRight') keyR=true;
  if(e.code==='Space') keyBrake=true;
  if(e.key==='p' || e.key==='P'){ paused=!paused; statusEl.textContent = paused ? 'Paused' : 'Running'; }
  if(e.key==='r' || e.key==='R') reset();
});
addEventListener('keyup',e=>{
  if(e.code==='ArrowLeft') keyL=false;
  if(e.code==='ArrowRight') keyR=false;
  if(e.code==='Space') keyBrake=false;
});

/* ============================
   物理コア
   2質点 + 2剛体リンク + 移動上端
============================ */
function enforceConstraints(){
  // r1 on circle around r0; r2 on circle around r1
  const r0 = {x:state.x0, y:0};
  // position correction
  let u1 = sub(state.r1, r0); let n1 = norm(u1); state.r1 = add(r0, mul(n1, P.L1));
  let u2 = sub(state.r2, state.r1); let n2 = norm(u2); state.r2 = add(state.r1, mul(n2, P.L2));
  // velocity projection (radial relative velocity zero)
  const v0v = {x:state.v0, y:0};
  const w1 = dot(sub(state.v1, v0v), n1);
  state.v1 = sub(state.v1, mul(n1, w1));
  const w2 = dot(sub(state.v2, state.v1), n2);
  // momentum split
  const alpha = (P.m2/(P.m1+P.m2))*w2;
  const beta  = (P.m1/(P.m1+P.m2))*w2;
  state.v1 = add(state.v1, mul(n2, alpha));
  state.v2 = sub(state.v2, mul(n2, beta));
}

function stepOnce(){
  const dt = P.dt;

  // ---- hoist dynamics (manual control) ----
  let ax = 0;
  if(keyL) ax -= P.amax;
  if(keyR) ax += P.amax;
  if(keyBrake){
    const need = -state.v0 / dt;
    ax = clamp(need, -P.amax, P.amax);
  }
  state.a0 = ax;
  state.v0 = clamp(state.v0 + ax*dt, -P.vmax, P.vmax);
  state.x0 += state.v0*dt;

  // ---- chain tensions via constraint accelerations ----
  // unit vectors
  const r0 = {x:state.x0, y:0};
  const u1 = sub(state.r1, r0); const n1 = norm(u1);
  const u2 = sub(state.r2, state.r1); const n2 = norm(u2);
  const cosphi = clamp(dot(n1,n2), -1, 1);
  // relative velocities
  const v0v = {x:state.v0, y:0};
  const v1rel = sub(state.v1, v0v);
  const v2rel = sub(state.v2, state.v1);
  const S1 = (dot(v1rel,v1rel)) / P.L1;
  const S2 = (dot(v2rel,v2rel)) / P.L2;

  // Linear system:  [ (1/m1)  (-cos/m1) ] [T1] = [ S1 + n1·g - n1·a0 ]
  //                 [ (cos/m1) -(1/m2+1/m1)] [T2]   [      -S2         ]
  const RHS1 = S1 + dot(n1,{x:0,y:-g}) - dot(n1,{x:state.a0,y:0});
  const a11 = 1/P.m1, a12 = -cosphi/P.m1;
  const a21 = cosphi/P.m1, a22 = -(1/P.m2 + 1/P.m1);
  const det = a11*a22 - a12*a21;
  let T1=0, T2=0;
  if(Math.abs(det) > 1e-12){
    T1 = (RHS1*a22 - a12*(-S2)) / det;
    T2 = (a11*(-S2) - a21*RHS1) / det;
  }
  // accelerations
  const gvec = {x:0,y:-g};
  const a1 = add(gvec, add(mul(n1, -T1/P.m1), mul(n2, T2/P.m1)));
  const a2 = add(gvec, mul(n2, -T2/P.m2));

  // integrate (semi-implicit Euler) & project constraints
  state.v1 = add(state.v1, mul(a1, dt));
  state.v2 = add(state.v2, mul(a2, dt));
  state.r1 = add(state.r1, mul(state.v1, dt));
  state.r2 = add(state.r2, mul(state.v2, dt));
  enforceConstraints();

  // observables
  const u1f = sub(state.r1, r0);
  const u2f = sub(state.r2, state.r1);
  state.theta1 = Math.atan2(u1f.x, -u1f.y);
  state.theta2 = Math.atan2(u2f.x, -u2f.y);

  // log
  dataTime.push(state.t);
  dataTh1.push(state.theta1*DEG);
  dataTh2.push(state.theta2*DEG);
  dataVx.push(state.v2.x);

  state.t += dt;
}

/* ============================
   ループ
============================ */
let last=performance.now(), acc=0;
function loop(now){
  const el = (now-last)/1000; last = now;
  if(!paused){
    acc += Math.min(el, 0.2);
    while(acc >= P.dt && state.t <= P.T){
      stepOnce();
      acc -= P.dt;
    }
  }
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ============================
   Excel 出力
============================ */
function downloadExcel(){
  if(dataTime.length===0){ statusEl.textContent='データがありません。開始して少し動かしてください。'; return; }
  const wb = XLSX.utils.book_new();

  // Angles sheet
  const rows1 = [['time [s]','theta1 [deg]','theta2 [deg]']];
  for(let i=0;i<dataTime.length;i++){
    rows1.push([+dataTime[i].toFixed(6), +dataTh1[i].toFixed(6), +dataTh2[i].toFixed(6)]);
  }
  const ws1 = XLSX.utils.aoa_to_sheet(rows1);
  XLSX.utils.book_append_sheet(wb, ws1, 'Angles');

  // Work_Vx sheet
  const rows2 = [['time [s]','work vx [m/s]']];
  for(let i=0;i<dataTime.length;i++){
    rows2.push([+dataTime[i].toFixed(6), +dataVx[i].toFixed(6)]);
  }
  const ws2 = XLSX.utils.aoa_to_sheet(rows2);
  XLSX.utils.book_append_sheet(wb, ws2, 'Work_Vx');

  XLSX.writeFile(wb, 'hoist_twochains_sim.xlsx');
  statusEl.textContent = 'Excel を出力しました。';
}

/* ============================
   UI ボタン
============================ */
document.getElementById('start').onclick = ()=>{ paused=false; statusEl.textContent='Running'; };
document.getElementById('pause').onclick = ()=>{ paused=true; statusEl.textContent='Paused'; };
document.getElementById('reset').onclick = reset;
document.getElementById('download').onclick = downloadExcel;

</script>
</body>
</html>
